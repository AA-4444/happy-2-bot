{# templates/index.html #}
{% extends "base.html" %}
{% block content %}

<style>
  /* Inherit all theme tokens from base.html — only component styles here */

  .crm-wrap { max-width:1100px; margin:0 auto; padding:24px 16px; position:relative; }

  /* Header */
  .crm-header {
	display:flex; align-items:center; justify-content:space-between;
	margin-bottom:24px;
  }
  .crm-header-left { display:flex; align-items:center; gap:12px; }
  .crm-header-logo {
	width:36px; height:36px; border-radius:10px;
	background:var(--primary); color:var(--primaryFg);
	display:flex; align-items:center; justify-content:center;
	font-weight:700; font-size:14px;
  }
  .crm-header h1 { font-size:18px; font-weight:600; }
  .crm-header p { font-size:12px; color:var(--muted); }

  /* Stats */
  .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:24px; }
  @media(max-width:768px){ .stats-grid { grid-template-columns:repeat(2,1fr); } }
  .stat-card {
	background:var(--card); border:1px solid var(--border);
	border-radius:14px; padding:20px; display:flex; align-items:center; gap:14px;
	box-shadow:var(--shadow); transition:border-color .2s;
  }
  .stat-card:hover { border-color:var(--primary); }
  .stat-icon {
	width:40px; height:40px; border-radius:10px;
	display:flex; align-items:center; justify-content:center; font-size:16px;
  }
  .stat-icon.users { background:hsl(168 70% 48% / .12); color:var(--primary); }
  .stat-icon.active { background:hsl(142 60% 45% / .12); color:hsl(142 60% 45%); }
  .stat-icon.starts { background:hsl(210 80% 55% / .12); color:hsl(210 80% 55%); }
  .stat-icon.msgs { background:hsl(38 92% 50% / .12); color:hsl(38 92% 50%); }
  .stat-label { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.05em; font-weight:600; }
  .stat-value { font-size:24px; font-weight:700; font-family:'JetBrains Mono', monospace; }

  /* Card — override base.html .card inside content block */
  .crm-wrap .card {
	background:var(--card); border:1px solid var(--border);
	border-radius:14px; overflow:hidden; margin-bottom:24px;
	box-shadow:var(--shadow);
  }
  .card-head {
	padding:20px; border-bottom:1px solid var(--border);
	display:flex; align-items:flex-start; gap:10px;
  }
  .card-head-icon { font-size:16px; margin-top:3px; color:var(--primary); }
  .card-head h2 { font-size:16px; font-weight:600; }
  .card-head p { font-size:13px; color:var(--muted); margin-top:2px; }
  .card-hint { padding:10px 20px; background:var(--panel2); border-bottom:1px solid var(--border); font-size:12px; color:var(--muted2); }

  /* Table */
  .tbl { width:100%; border-collapse:collapse; font-size:13px; }
  .tbl th {
	text-align:left; padding:10px 20px; font-weight:600; font-size:11px;
	color:var(--muted); background:var(--panel2);
	border-bottom:1px solid var(--border); text-transform:uppercase; letter-spacing:0.04em;
  }
  .tbl th.r, .tbl td.r { text-align:right; }
  .tbl td { padding:10px 20px; border-bottom:1px solid var(--border); }
  .tbl tr:last-child td { border-bottom:none; }
  .tbl tr:hover td { background:var(--btnHover); }
  .tbl .mono { font-size:12px; font-family:'JetBrains Mono', monospace; }
  .tbl .link { color:var(--primary); text-decoration:none; }
  .tbl .dim { color:var(--muted); }

  /* Toolbar */
  .toolbar {
	display:flex; align-items:center; justify-content:space-between;
	padding:16px 20px; border-bottom:1px solid var(--border);
  }
  .toolbar-left { display:flex; align-items:center; gap:10px; }
  .toolbar-left h2 { font-size:16px; font-weight:600; }
  .crm-wrap .badge {
	font-size:11px; font-family:'JetBrains Mono', monospace;
	background:var(--panel2); color:var(--muted); border:1px solid var(--border);
	padding:2px 8px; border-radius:6px;
  }

  /* Form */
  .form-row {
	display:flex; flex-wrap:wrap; align-items:flex-end; gap:12px; padding:20px;
	background:var(--panel2); border-bottom:1px solid var(--border);
  }
  .form-group { display:flex; flex-direction:column; gap:5px; }
  .form-group.grow { flex:1; min-width:160px; }
  .form-label { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.04em; font-weight:600; }

  .crm-wrap input[type="text"],
  .crm-wrap input[type="number"],
  .crm-wrap select {
	height:36px !important; background:var(--inputBg) !important; border:1px solid var(--inputBorder) !important; border-radius:8px !important;
	padding:0 10px !important; font-size:13px !important; color:var(--fg) !important;
	font-family:'Inter', system-ui, sans-serif; outline:none !important; transition:border-color .15s, box-shadow .15s;
  }
  .crm-wrap input:focus, .crm-wrap select:focus {
	border-color:var(--ringBorder) !important; box-shadow:0 0 0 3px var(--ring) !important;
  }
  .crm-wrap input::placeholder { color:var(--muted) !important; }
  .crm-wrap select { cursor:pointer; }

  /* Buttons */
  .btn {
	display:inline-flex; align-items:center; gap:6px;
	height:36px; padding:0 14px; border-radius:8px; font-size:13px; font-weight:500;
	border:1px solid transparent; cursor:pointer; transition:all .15s; font-family:'Inter', system-ui, sans-serif;
	white-space:nowrap;
  }
  .btn i { font-size:12px; }
  .btn-primary { background:var(--primary) !important; color:var(--primaryFg) !important; border-color:var(--primary) !important; }
  .btn-primary:hover { opacity:.9; }
  .btn-sm { height:30px; padding:0 10px; font-size:12px; }
  .btn-outline { background:transparent; border:1px solid var(--border); color:var(--muted); }
  .btn-outline:hover { background:var(--btnHover); border-color:var(--muted); }
  .btn-danger { background:var(--dangerBg) !important; color:var(--dangerFg) !important; border:1px solid var(--dangerBorder) !important; }
  .btn-danger:hover { background:var(--dangerHover) !important; }
  .btn-ghost { background:none; border:none; color:var(--muted); padding:0 6px; height:30px; cursor:pointer; border-radius:6px; display:inline-flex; align-items:center; }
  .btn-ghost:hover { background:var(--btnHover); color:var(--fg); }
  .btn-link {
	display:inline-flex; align-items:center; gap:6px;
	font-size:13px; color:var(--primary); background:none; border:none;
	cursor:pointer; text-decoration:none;
  }
  .btn-link:hover { opacity:0.8; }

  /* Pill */
  .pill {
	display:inline-flex; align-items:center; font-size:11px; font-weight:600;
	padding:3px 10px; border-radius:999px; letter-spacing:0.02em; text-transform:uppercase;
	cursor:pointer;
  }
  .pill-on { background:hsl(142 60% 45% / .12); color:hsl(142 60% 45%); border:1px solid hsl(142 60% 45% / .3); }
  .pill-off { background:var(--panel2); color:var(--muted); border:1px solid var(--border); }
  .pill-auto { background:hsl(142 60% 45% / .12); color:hsl(142 60% 45%); }
  .pill-manual { background:hsl(38 92% 50% / .12); color:hsl(38 92% 50%); }

  /* Item rows */
  .item-row {
	display:flex; align-items:center; justify-content:space-between;
	padding:14px 20px; border-bottom:1px solid var(--border); transition:background .1s;
  }
  .item-row:last-child { border-bottom:none; }
  .item-row:hover { background:var(--btnHover); }
  .item-left { flex:1; min-width:0; }
  .item-title { font-size:14px; font-weight:500; }
  .item-meta { font-size:12px; color:var(--muted); margin-top:2px; }
  .item-meta .mono { color:var(--primary); font-family:'JetBrains Mono', monospace; }
  .item-actions { display:flex; align-items:center; gap:8px; margin-left:12px; }

  /* Sequence row */
  .seq-row {
	display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;
	padding:14px 20px; border-bottom:1px solid var(--border); transition:background .1s;
  }
  .seq-row:hover { background:var(--btnHover); }
  .seq-left { display:flex; align-items:center; gap:10px; }
  .seq-right { display:flex; align-items:center; gap:8px; }

  /* Flow card */
  .flow-header {
	display:flex; align-items:center; justify-content:space-between;
	padding:12px 20px; border-bottom:1px solid var(--border);
	transition:background .1s; cursor:pointer;
  }
  .flow-header:hover { background:var(--btnHover); }
  .flow-name { font-family:'JetBrains Mono', monospace; font-size:13px; font-weight:500; }
  .flow-controls { display:flex; align-items:center; gap:4px; }
  .flow-btn {
	width:28px; height:28px; display:flex; align-items:center; justify-content:center;
	border:none; background:none; color:var(--muted); cursor:pointer;
	border-radius:6px; transition:all .15s; font-size:13px;
  }
  .flow-btn:hover { background:var(--btnHover); color:var(--fg); }
  .flow-btn.del:hover { background:var(--dangerBg); color:var(--danger); }
  .flow-detail { padding:16px 20px; background:var(--panel2); border-bottom:1px solid var(--border); }
  .flow-detail-inner { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
  .flow-detail h4 { font-size:13px; font-weight:600; margin-bottom:10px; }

  /* Checkbox */
  .crm-wrap input[type="checkbox"] { accent-color:var(--primary); width:15px; height:15px; cursor:pointer; }
  .check-label { display:inline-flex; align-items:center; gap:6px; font-size:13px; color:var(--muted); cursor:pointer; }

  /* Weekday buttons */
  .weekday-btn {
	padding:4px 10px; font-size:11px; border-radius:6px;
	border:1px solid var(--border); background:var(--inputBg);
	color:var(--muted); cursor:pointer; transition:all .15s;
  }
  .weekday-btn.active { background:var(--primary) !important; color:var(--primaryFg) !important; border-color:var(--primary) !important; }

  /* Time group */
  .time-group { display:flex; align-items:center; gap:4px; }
  .time-input { width:56px !important; text-align:center; }
  .time-sep { font-weight:700; color:var(--muted); font-size:16px; }

  /* Inline helpers */
  .inline { display:flex; align-items:center; gap:8px; }
  .gap-sm { gap:6px; }
  .chain-arrow { color:var(--muted); font-size:14px; margin:0 2px; }
  .empty { padding:24px 20px; font-size:13px; color:var(--muted); text-align:center; }

  @media(max-width:768px){
	.form-row { flex-direction:column; align-items:stretch; }
	.form-group { width:100%; }
	.form-group input, .form-group select { width:100% !important; }
	.seq-row { flex-direction:column; align-items:flex-start; }
	.item-row { flex-direction:column; align-items:flex-start; gap:8px; }
	.item-actions { margin-left:0; }
	.crm-header { flex-direction:column; align-items:flex-start; gap:12px; }
  }
</style>

<!-- bgGlow provided by base.html -->

<div class="crm-wrap">

  <!-- Header provided by base.html -->

  <!-- Stats -->
  <div class="stats-grid">
	<div class="stat-card">
	  <div class="stat-icon users"><i class="fa-solid fa-users"></i></div>
	  <div>
		<div class="stat-label">Users</div>
		<div class="stat-value">{{ stats.total_users if stats is defined else "-" }}</div>
	  </div>
	</div>
	<div class="stat-card">
	  <div class="stat-icon active"><i class="fa-solid fa-signal"></i></div>
	  <div>
		<div class="stat-label">Active (1h)</div>
		<div class="stat-value">{{ stats.active_last_hour if stats is defined else "-" }}</div>
	  </div>
	</div>
	<div class="stat-card">
	  <div class="stat-icon starts"><i class="fa-solid fa-play"></i></div>
	  <div>
		<div class="stat-label">/start</div>
		<div class="stat-value">{{ stats.total_starts if stats is defined else "-" }}</div>
	  </div>
	</div>
	<div class="stat-card">
	  <div class="stat-icon msgs"><i class="fa-solid fa-comment-dots"></i></div>
	  <div>
		<div class="stat-label">Messages</div>
		<div class="stat-value">{{ stats.total_messages if stats is defined else "-" }}</div>
	  </div>
	</div>
  </div>

  <!-- Users Table -->
  <div class="card">
	<div class="toolbar">
	  <div class="toolbar-left">
		<h2><i class="fa-solid fa-user-group" style="font-size:14px;color:var(--primary);margin-right:6px"></i>Latest users</h2>
		<span class="badge">{{ stats.total_users if stats is defined else "" }}</span>
	  </div>
	  <a href="/export_users" class="btn-link"><i class="fa-solid fa-file-export"></i> Export Excel</a>
	</div>
	<div style="overflow-x:auto;">
	  <table class="tbl">
		<thead>
		  <tr>
			<th>user_id</th>
			<th>username</th>
			<th>first_seen</th>
			<th>last_seen</th>
			<th class="r">starts</th>
			<th class="r">msgs</th>
		  </tr>
		</thead>
		<tbody>
		  {% if users is defined and users|length > 0 %}
			{% for u in users %}
			  <tr>
				<td class="mono">{{ u.user_id }}</td>
				<td>
				  {% if u.username %}
					<span class="link">@{{ u.username }}</span>
				  {% else %}
					<span class="dim">—</span>
				  {% endif %}
				</td>
				<td class="mono dim" style="font-size:12px;">{{ u.first_seen }}</td>
				<td class="mono dim" style="font-size:12px;">{{ u.last_seen }}</td>
				<td class="r">{{ u.starts_count }}</td>
				<td class="r">{{ u.messages_count }}</td>
			  </tr>
			{% endfor %}
		  {% else %}
			<tr><td colspan="6" class="dim">Нет данных по пользователям. Проверь что bot пишет в таблицу bot_users.</td></tr>
		  {% endif %}
		</tbody>
	  </table>
	</div>
  </div>

  <!-- Broadcasts -->
  <div class="card">
	<div class="card-head">
	  <span class="card-head-icon"><i class="fa-solid fa-tower-broadcast"></i></span>
	  <div>
		<h2>Broadcasts (recurring)</h2>
		<p>Авто-рассылки: запуск flow по расписанию для всех или конкретного user_id.</p>
	  </div>
	</div>

	<form method="POST" action="/add_broadcast">
	  <div class="form-row">
		<div class="form-group grow">
		  <span class="form-label">Title</span>
		  <input type="text" name="title" placeholder="Broadcast title">
		</div>
		<div class="form-group">
		  <span class="form-label">Flow</span>
		  <select name="flow">
			{% for f in flows %}
			  <option value="{{ f }}">{{ f }}</option>
			{% endfor %}
		  </select>
		</div>
		<div class="form-group">
		  <span class="form-label">Target</span>
		  <select name="target_type" id="bc_target_type" onchange="document.getElementById('bc_uid').style.display=this.value==='single'?'flex':'none'">
			<option value="all">all users</option>
			<option value="single">single user_id</option>
		  </select>
		</div>
		<div class="form-group" id="bc_uid" style="display:none">
		  <span class="form-label">User ID</span>
		  <input type="number" name="target_user_id" placeholder="user_id" style="width:100px">
		</div>
		<div class="form-group">
		  <span class="form-label">Schedule</span>
		  <select name="schedule_type" id="bc_sched" onchange="
			document.getElementById('bc_monthly').style.display=this.value==='monthly'?'flex':'none';
			document.getElementById('bc_weekly').style.display=this.value==='weekly'?'flex':'none';
			document.getElementById('bc_every').style.display=this.value==='every_n_days'?'flex':'none';
		  ">
			<option value="monthly">monthly</option>
			<option value="weekly">weekly</option>
			<option value="every_n_days">every N days</option>
		  </select>
		</div>
		<div class="form-group" id="bc_monthly">
		  <span class="form-label">Days of month</span>
		  <input type="text" name="days_of_month" placeholder="1,15" value="1,15" style="width:100px">
		</div>
		<div class="form-group" id="bc_weekly" style="display:none">
		  <span class="form-label">Days of week</span>
		  <div class="inline gap-sm" style="flex-wrap:wrap;height:36px;align-items:center;">
			{% for d in ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'] %}
			  <label class="weekday-btn"><input type="checkbox" name="days_of_week" value="{{ d }}" style="display:none" onchange="this.parentElement.classList.toggle('active')"> {{ d }}</label>
			{% endfor %}
		  </div>
		</div>
		<div class="form-group" id="bc_every" style="display:none">
		  <span class="form-label">Every N days</span>
		  <input type="number" name="interval_days" value="3" style="width:80px">
		</div>
		<div class="form-group">
		  <span class="form-label">At</span>
		  <div class="time-group">
			<input type="number" name="at_hour" value="10" min="0" max="23" class="time-input">
			<span class="time-sep">:</span>
			<input type="number" name="at_minute" value="00" min="0" max="59" class="time-input">
		  </div>
		</div>
		<div class="form-group">
		  <span class="form-label">&nbsp;</span>
		  <label class="check-label" style="height:36px;">
			<input type="checkbox" name="is_active" value="1" checked>
			enabled
		  </label>
		</div>
		<div class="form-group">
		  <span class="form-label">&nbsp;</span>
		  <button type="submit" class="btn btn-primary">
			<i class="fa-solid fa-plus"></i> Add broadcast
		  </button>
		</div>
	  </div>
	</form>

	<div class="card-hint">monthly: days 1,15 = 1 и 15 числа. every N days: запустит для всех пользователей каждые N дней.</div>

	<div>
	  {% if broadcasts is defined and broadcasts|length > 0 %}
		{% for b in broadcasts %}
		  {% set b_active = (b.is_active if b.is_active is defined else 0) %}
		  {% set target = ("ALL" if b.target_user_id is not defined or b.target_user_id is none else ("user_id=" ~ b.target_user_id)) %}
		  {% set st = (b.schedule_type if b.schedule_type is defined else "monthly") %}
		  <div class="item-row">
			<div class="item-left">
			  <div class="item-title">{{ b.title if b.title is defined and b.title else ("Broadcast: " ~ b.flow) }}</div>
			  <div class="item-meta">
				flow: <span class="mono">{{ b.flow }}</span>
				&bull; target: {{ target }}
				&bull; time: {{ "%02d"|format(b.at_hour|int) }}:{{ "%02d"|format(b.at_minute|int) }}
				{% if st == "monthly" %}
				  &bull; monthly days: {{ b.days_of_month }}
				{% elif st == "weekly" %}
				  &bull; weekly days: {{ b.days_of_week }}
				{% else %}
				  &bull; every: {{ b.interval_days }} days
				{% endif %}
			  </div>
			</div>
			<div class="item-actions">
			  <form method="POST" action="/toggle_broadcast/{{ b.id }}" style="display:inline">
				<button type="submit" class="pill {% if b_active|int == 1 %}pill-on{% else %}pill-off{% endif %}">
				  {% if b_active|int == 1 %}ENABLED{% else %}DISABLED{% endif %}
				</button>
			  </form>
			  <form method="POST" action="/delete_broadcast/{{ b.id }}" style="display:inline" onsubmit="return confirm('Delete this broadcast?')">
				<button type="submit" class="btn btn-sm btn-danger"><i class="fa-solid fa-trash-can"></i> Delete</button>
			  </form>
			</div>
		  </div>
		{% endfor %}
	  {% else %}
		<div class="empty">Пока нет рассылок. Добавь monthly broadcast.</div>
	  {% endif %}
	</div>
  </div>

  <!-- /start Sequence -->
  <div class="card">
	<div class="card-head">
	  <span class="card-head-icon"><i class="fa-solid fa-bolt"></i></span>
	  <div>
		<h2>/start sequence</h2>
		<p>Какие flow запускаются после /start (delay относительно /start)</p>
	  </div>
	</div>
	<div class="card-hint">пример: welcome=0 min, day1=5 min, day2=1 day</div>

	{% for f in flows %}
	  {% set tr = (triggers[f] if (triggers is defined and f in triggers) else None) %}
	  {% set enabled = (tr.enabled if tr and tr.enabled is defined else false) %}
	  {% set unit = (tr.offset_unit if tr and tr.offset_unit is defined else "minutes") %}
	  <form method="POST" action="/save_trigger/{{ f }}">
		<div class="seq-row">
		  <div class="seq-left">
			<span class="badge" style="font-size:13px;font-weight:500;">{{ f }}</span>
			<label class="check-label">
			  <input type="checkbox" name="enabled" value="1" {% if enabled %}checked{% endif %}>
			  run after /start
			</label>
		  </div>
		  <div class="seq-right">
			<span style="font-size:12px;color:var(--muted);">delay</span>
			<input type="number" name="offset_value" value="{{ tr.offset_value if tr else 0 }}" style="width:70px;text-align:center;">
			<select name="offset_unit">
			  <option value="minutes" {% if unit == "minutes" %}selected{% endif %}>minutes</option>
			  <option value="hours" {% if unit == "hours" %}selected{% endif %}>hours</option>
			  <option value="days" {% if unit == "days" %}selected{% endif %}>days</option>
			</select>
			<button type="submit" class="btn btn-sm btn-primary"><i class="fa-solid fa-floppy-disk"></i> Save</button>
		  </div>
		</div>
	  </form>
	{% endfor %}
  </div>

  <!-- After Flow → Start Flow -->
  <div class="card">
	<div class="card-head">
	  <span class="card-head-icon"><i class="fa-solid fa-code-branch"></i></span>
	  <div>
		<h2>After flow → start flow</h2>
		<p>Правила: после завершения flow A запустить flow B через задержку (welcome → day1 и т.д.)</p>
	  </div>
	</div>

	<form method="POST" action="/add_action">
	  <div class="form-row">
		<div class="form-group">
		  <span class="form-label">After</span>
		  <select name="after_flow">
			{% for f in flows %}<option value="{{ f }}">{{ f }}</option>{% endfor %}
		  </select>
		</div>
		<div class="form-group">
		  <span class="form-label">Start</span>
		  <select name="target_flow">
			{% for f in flows %}<option value="{{ f }}">{{ f }}</option>{% endfor %}
		  </select>
		</div>
		<div class="form-group">
		  <span class="form-label">After</span>
		  <div class="inline">
			<input type="number" name="delay_value" value="5" style="width:70px">
			<select name="delay_unit">
			  <option value="seconds">seconds</option>
			  <option value="minutes">minutes</option>
			  <option value="hours">hours</option>
			  <option value="days">days</option>
			</select>
		  </div>
		</div>
		<div class="form-group">
		  <span class="form-label">&nbsp;</span>
		  <button type="submit" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Add rule</button>
		</div>
	  </div>
	</form>
	<div class="card-hint">пример: After welcome start day1 after 5 minutes</div>

	<div>
	  {% if actions is defined and actions|length > 0 %}
		{% for a in actions %}
		  {% set a_active = (a.is_active if a.is_active is defined else 0) %}
		  <div class="item-row">
			<div class="inline" style="gap:10px;">
			  <span class="badge" style="font-size:13px;font-weight:500;">{{ a.after_flow }}</span>
			  <i class="fa-solid fa-arrow-right chain-arrow"></i>
			  <span class="badge" style="font-size:13px;font-weight:500;">{{ a.target_flow }}</span>
			  <span style="font-size:12px;color:var(--muted);margin-left:8px;">delay: {{ a.delay_seconds }}s</span>
			</div>
			<div class="item-actions">
			  <form method="POST" action="/toggle_action/{{ a.id }}" style="display:inline">
				<button type="submit" class="pill {% if a_active|int == 1 %}pill-on{% else %}pill-off{% endif %}">
				  {% if a_active|int == 1 %}ENABLED{% else %}DISABLED{% endif %}
				</button>
			  </form>
			  <form method="POST" action="/delete_action/{{ a.id }}" style="display:inline" onsubmit="return confirm('Delete this rule?')">
				<button type="submit" class="btn btn-sm btn-danger"><i class="fa-solid fa-trash-can"></i> Delete</button>
			  </form>
			</div>
		  </div>
		{% endfor %}
	  {% else %}
		<div class="empty">Пока нет правил. Добавь welcome → day1.</div>
	  {% endif %}
	</div>
  </div>

  <!-- Flows -->
  <div class="card">
	<div class="card-head">
	  <span class="card-head-icon"><i class="fa-solid fa-layer-group"></i></span>
	  <div>
		<h2>Flows</h2>
		<p>Порядок flow меняется ↑/↓. Удаление — безопасно (сотрёт блоки).</p>
	  </div>
	</div>

	<form method="POST" action="/add_flow" class="form-row">
	  <div class="form-group grow">
		<input type="text" name="flow_name" placeholder="New flow name">
	  </div>
	  <div class="form-group">
		<button type="submit" class="btn btn-primary"><i class="fa-solid fa-plus"></i> New flow</button>
	  </div>
	</form>

	{% for f in flows %}
	  {% set tr = (triggers[f] if (triggers is defined and f in triggers) else None) %}
	  {% set mode = (tr.mode if tr and tr.mode is defined else "off") %}
	  {% set enabled = (tr.enabled if tr and tr.enabled is defined else false) %}

	  <div>
		<div class="flow-header" onclick="var d=document.getElementById('flow-detail-{{ loop.index }}');d.style.display=d.style.display==='none'?'block':'none';">
		  <div class="inline" style="gap:10px;">
			<span class="flow-name">{{ f }}</span>
			<span class="pill {% if mode == 'auto' %}pill-auto{% elif mode == 'manual' %}pill-manual{% else %}pill-off{% endif %}">
			  {{ mode|upper }}
			</span>
			<a href="/flow/{{ f }}" class="btn-link" style="font-size:12px;" onclick="event.stopPropagation();"><i class="fa-solid fa-arrow-up-right-from-square" style="font-size:10px"></i> open</a>
		  </div>
		  <div class="flow-controls">
			<form method="POST" action="/move_flow/{{ f }}/up" style="display:inline" onclick="event.stopPropagation();">
			  <button type="submit" class="flow-btn"><i class="fa-solid fa-arrow-up"></i></button>
			</form>
			<form method="POST" action="/move_flow/{{ f }}/down" style="display:inline" onclick="event.stopPropagation();">
			  <button type="submit" class="flow-btn"><i class="fa-solid fa-arrow-down"></i></button>
			</form>
			<form method="POST" action="/delete_flow/{{ f }}" style="display:inline" onclick="event.stopPropagation();" onsubmit="return confirm('Delete flow {{ f }}?')">
			  <button type="submit" class="flow-btn del"><i class="fa-solid fa-trash-can"></i></button>
			</form>
		  </div>
		</div>

		<div id="flow-detail-{{ loop.index }}" class="flow-detail" style="display:none;">
		  <div class="flow-detail-inner">
			<h4>Delivery mode</h4>
			<form method="POST" action="/save_flow_mode/{{ f }}">
			  <div style="display:flex;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:12px;">
				<span style="font-size:12px;color:var(--muted);">Mode</span>
				<select name="mode">
				  <option value="off" {% if mode == "off" %}selected{% endif %}>off</option>
				  <option value="manual" {% if mode == "manual" %}selected{% endif %}>manual</option>
				  <option value="auto" {% if mode == "auto" %}selected{% endif %}>auto</option>
				</select>
				<button type="submit" class="btn btn-sm btn-primary"><i class="fa-solid fa-floppy-disk"></i> Save</button>
			  </div>
			</form>
			<form method="POST" action="/save_flow_auto/{{ f }}">
			  <div style="border-top:1px solid var(--border);padding-top:12px;">
				<h4>Auto-send after /start</h4>
				<div style="display:flex;align-items:center;flex-wrap:wrap;gap:8px;">
				  <input type="number" name="offset_value" value="{{ tr.offset_value if tr else 0 }}" style="width:70px;text-align:center;">
				  {% set unit2 = (tr.offset_unit if tr and tr.offset_unit is defined else "days") %}
				  <select name="offset_unit">
					<option value="minutes" {% if unit2 == "minutes" %}selected{% endif %}>minutes</option>
					<option value="hours" {% if unit2 == "hours" %}selected{% endif %}>hours</option>
					<option value="days" {% if unit2 == "days" %}selected{% endif %}>days</option>
				  </select>
				  <label class="check-label">
					<input type="checkbox" name="enabled" value="1" {% if enabled %}checked{% endif %}>
					enabled
				  </label>
				  <button type="submit" class="btn btn-sm btn-primary"><i class="fa-solid fa-floppy-disk"></i> Save</button>
				</div>
				<p style="font-size:11px;color:var(--muted2);margin-top:8px;">Пример: day2 → 1 days, day3 → 2 days.</p>
			  </div>
			</form>
		  </div>
		</div>
	  </div>
	{% endfor %}

	{% if flows|length == 0 %}
	  <div class="empty">Нет flows. Запусти seed.py.</div>
	{% endif %}
  </div>

</div>

<!-- theme toggle script provided by base.html -->

{% endblock %}
