{# templates/index.html #}
{% extends "base.html" %}
{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
  :root {
	--bg: #0f1318;
	--bg-card: #151a21;
	--bg-muted: #1a2029;
	--bg-hover: #1e252e;
	--border: #232b36;
	--text: #e2e8f0;
	--text-muted: #6b7a8d;
	--primary: #2dd4a8;
	--primary-dim: rgba(45,212,168,0.12);
	--success: #34d399;
	--success-dim: rgba(52,211,153,0.15);
	--warning: #f59e0b;
	--warning-dim: rgba(245,158,11,0.15);
	--info: #3b82f6;
	--info-dim: rgba(59,130,246,0.15);
	--danger: #ef4444;
	--danger-dim: rgba(239,68,68,0.12);
	--radius: 8px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
	font-family: 'Inter', system-ui, sans-serif;
	background: var(--bg);
	color: var(--text);
	-webkit-font-smoothing: antialiased;
	line-height: 1.5;
  }
  code, .mono { font-family: 'JetBrains Mono', monospace; }
  ::-webkit-scrollbar { width:6px; height:6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius:3px; }
  .crm-wrap { max-width:1200px; margin:0 auto; padding:24px 16px; }
  /* Header */
  .crm-header {
	display:flex; align-items:center; gap:12px;
	padding:16px 20px; background:var(--bg-card);
	border:1px solid var(--border); border-radius:var(--radius);
	margin-bottom:24px;
  }
  .crm-header-icon {
	width:40px; height:40px; border-radius:var(--radius);
	background:var(--primary-dim); display:flex; align-items:center; justify-content:center;
	color:var(--primary); font-size:20px;
  }
  .crm-header h1 { font-size:18px; font-weight:600; }
  .crm-header p { font-size:12px; color:var(--text-muted); }
  /* Stats */
  .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:24px; }
  @media(max-width:768px){ .stats-grid { grid-template-columns:repeat(2,1fr); } }
  .stat-card {
	background:var(--bg-card); border:1px solid var(--border);
	border-radius:var(--radius); padding:20px; display:flex; align-items:center; gap:14px;
	transition:border-color .2s;
  }
  .stat-card:hover { border-color:rgba(45,212,168,0.3); }
  .stat-icon {
	width:40px; height:40px; border-radius:var(--radius);
	display:flex; align-items:center; justify-content:center; font-size:18px;
  }
  .stat-icon.users { background:var(--primary-dim); color:var(--primary); }
  .stat-icon.active { background:var(--success-dim); color:var(--success); }
  .stat-icon.starts { background:var(--info-dim); color:var(--info); }
  .stat-icon.msgs { background:var(--warning-dim); color:var(--warning); }
  .stat-label { font-size:13px; color:var(--text-muted); }
  .stat-value { font-size:24px; font-weight:600; }
  /* Card */
  .card {
	background:var(--bg-card); border:1px solid var(--border);
	border-radius:var(--radius); overflow:hidden; margin-bottom:24px;
  }
  .card-head {
	padding:20px; border-bottom:1px solid var(--border);
	display:flex; align-items:flex-start; gap:10px;
  }
  .card-head-icon { font-size:18px; margin-top:2px; }
  .card-head h2 { font-size:16px; font-weight:600; }
  .card-head p, .card-hint { font-size:13px; color:var(--text-muted); }
  .card-hint { padding:12px 20px; background:var(--bg-muted); border-bottom:1px solid var(--border); font-size:12px; }
  /* Table */
  .tbl { width:100%; border-collapse:collapse; font-size:13px; }
  .tbl th {
	text-align:left; padding:10px 20px; font-weight:500;
	color:var(--text-muted); background:rgba(26,32,41,0.5);
	border-bottom:1px solid var(--border); font-size:12px;
  }
  .tbl th.r { text-align:right; }
  .tbl td { padding:10px 20px; border-bottom:1px solid rgba(35,43,54,0.5); }
  .tbl tr:hover td { background:var(--bg-hover); }
  .tbl td.r { text-align:right; }
  .tbl .mono { font-size:12px; }
  .tbl .link { color:var(--primary); text-decoration:none; }
  .tbl .dim { color:var(--text-muted); }
  /* Toolbar row above table */
  .toolbar {
	display:flex; align-items:center; justify-content:space-between;
	padding:16px 20px; border-bottom:1px solid var(--border);
  }
  .toolbar-left { display:flex; align-items:center; gap:10px; }
  .badge {
	font-size:11px; font-family:'JetBrains Mono',monospace;
	background:var(--bg-muted); color:var(--text-muted);
	padding:2px 8px; border-radius:4px;
  }
  .btn-link {
	display:inline-flex; align-items:center; gap:6px;
	font-size:13px; color:var(--primary); background:none; border:none;
	cursor:pointer; text-decoration:none; transition:opacity .2s;
  }
  .btn-link:hover { opacity:0.8; }
  /* Form elements */
  .form-row {
	display:flex; flex-wrap:wrap; gap:12px; padding:20px;
	background:rgba(26,32,41,0.3); border-bottom:1px solid var(--border);
  }
  .form-group { display:flex; flex-direction:column; gap:4px; }
  .form-group.grow { flex:1; min-width:160px; }
  .form-label { font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; }
  input[type="text"], input[type="number"], select, textarea {
	background:var(--bg); border:1px solid var(--border); border-radius:6px;
	padding:8px 12px; font-size:13px; color:var(--text);
	font-family:'Inter',sans-serif; outline:none; transition:border-color .2s;
  }
  input:focus, select:focus { border-color:var(--primary); }
  input::placeholder { color:var(--text-muted); }
  select { cursor:pointer; appearance:auto; }
  /* Buttons */
  .btn {
	display:inline-flex; align-items:center; gap:6px;
	padding:8px 16px; border-radius:6px; font-size:13px; font-weight:500;
	border:none; cursor:pointer; transition:all .2s; font-family:'Inter',sans-serif;
  }
  .btn-primary { background:var(--primary); color:#0f1318; }
  .btn-primary:hover { opacity:0.9; }
  .btn-secondary { background:var(--bg-muted); color:var(--text-muted); border:1px solid var(--border); }
  .btn-secondary:hover { background:var(--bg-hover); color:var(--text); }
  .btn-sm { padding:5px 12px; font-size:12px; }
  .btn-danger { background:var(--danger-dim); color:var(--danger); }
  .btn-danger:hover { background:rgba(239,68,68,0.2); }
  /* Pill badges */
  .pill {
	display:inline-block; font-size:11px; font-weight:600;
	padding:3px 10px; border-radius:99px; text-transform:uppercase; letter-spacing:0.3px;
  }
  .pill-on { background:var(--success-dim); color:var(--success); }
  .pill-off { background:var(--bg-muted); color:var(--text-muted); }
  .pill-auto { background:var(--success-dim); color:var(--success); }
  .pill-manual { background:var(--warning-dim); color:var(--warning); }
  /* Item rows */
  .item-row {
	display:flex; align-items:center; justify-content:space-between;
	padding:14px 20px; border-bottom:1px solid rgba(35,43,54,0.5);
	transition:background .15s;
  }
  .item-row:hover { background:var(--bg-hover); }
  .item-row:last-child { border-bottom:none; }
  .item-left { flex:1; min-width:0; }
  .item-title { font-size:14px; font-weight:500; }
  .item-meta { font-size:12px; color:var(--text-muted); margin-top:2px; }
  .item-meta .mono { color:rgba(45,212,168,0.8); }
  .item-actions { display:flex; align-items:center; gap:8px; margin-left:12px; }
  /* Flow card */
  .flow-header {
	display:flex; align-items:center; justify-content:space-between;
	padding:12px 20px; border-bottom:1px solid rgba(35,43,54,0.5);
	transition:background .15s; cursor:pointer;
  }
  .flow-header:hover { background:var(--bg-hover); }
  .flow-name { font-family:'JetBrains Mono',monospace; font-size:13px; font-weight:500; }
  .flow-controls { display:flex; align-items:center; gap:4px; }
  .flow-btn {
	width:28px; height:28px; display:flex; align-items:center; justify-content:center;
	border:none; background:none; color:var(--text-muted); cursor:pointer;
	border-radius:4px; transition:all .15s; font-size:14px;
  }
  .flow-btn:hover { background:var(--bg-muted); color:var(--text); }
  .flow-btn:disabled { opacity:0.3; cursor:default; }
  .flow-btn.del:hover { background:var(--danger-dim); color:var(--danger); }
  .flow-detail {
	padding:16px 20px; background:rgba(26,32,41,0.3);
	border-bottom:1px solid var(--border);
  }
  .flow-detail-inner {
	background:var(--bg-muted); border:1px solid var(--border);
	border-radius:var(--radius); padding:16px;
  }
  .flow-detail h4 { font-size:13px; font-weight:600; margin-bottom:10px; }
  .flow-detail .row { display:flex; align-items:center; flex-wrap:wrap; gap:8px; margin-bottom:10px; }
  /* Weekday buttons */
  .weekday-btn {
	padding:4px 10px; font-size:11px; border-radius:4px;
	border:1px solid var(--border); background:var(--bg);
	color:var(--text-muted); cursor:pointer; transition:all .15s;
  }
  .weekday-btn.active, .weekday-btn:checked {
	background:var(--primary); color:#0f1318; border-color:var(--primary);
  }
  /* Checkbox style */
  input[type="checkbox"] {
	accent-color: var(--primary); width:16px; height:16px; cursor:pointer;
  }
  .check-label { display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text-muted); cursor:pointer; }
  /* Sequence row */
  .seq-row {
	display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;
	padding:14px 20px; border-bottom:1px solid rgba(35,43,54,0.5);
	transition:background .15s;
  }
  .seq-row:hover { background:var(--bg-hover); }
  .seq-left { display:flex; align-items:center; gap:10px; }
  .seq-right { display:flex; align-items:center; gap:8px; }
  /* Chain arrow */
  .chain-arrow { color:var(--text-muted); font-size:16px; margin:0 4px; }
  /* Empty state */
  .empty { padding:20px; font-size:13px; color:var(--text-muted); }
  /* Time inputs */
  .time-group { display:flex; align-items:center; gap:4px; }
  .time-input { width:56px; text-align:center; }
  .time-sep { font-weight:700; color:var(--text-muted); font-size:16px; }
  /* Inline flex row */
  .inline { display:flex; align-items:center; gap:8px; }
  .gap-sm { gap:6px; }
  .ml-auto { margin-left:auto; }
  .mt-sm { margin-top:8px; }
  .mb-sm { margin-bottom:8px; }
</style>
<div class="crm-wrap">
  <!-- Header -->
  <div class="crm-header">
	<div class="crm-header-icon">ü§ñ</div>
	<div>
	  <h1>Bot CRM</h1>
	  <p>Dashboard & Flow Manager</p>
	</div>
  </div>
  <!-- Stats -->
  <div class="stats-grid">
	<div class="stat-card">
	  <div class="stat-icon users">üë•</div>
	  <div>
		<div class="stat-label">Users</div>
		<div class="stat-value">{{ stats.total_users if stats is defined else "‚Äî" }}</div>
	  </div>
	</div>
	<div class="stat-card">
	  <div class="stat-icon active">‚ö°</div>
	  <div>
		<div class="stat-label">Active (1h)</div>
		<div class="stat-value">{{ stats.active_last_hour if stats is defined else "‚Äî" }}</div>
	  </div>
	</div>
	<div class="stat-card">
	  <div class="stat-icon starts">‚ñ∂</div>
	  <div>
		<div class="stat-label">/start</div>
		<div class="stat-value">{{ stats.total_starts if stats is defined else "‚Äî" }}</div>
	  </div>
	</div>
	<div class="stat-card">
	  <div class="stat-icon msgs">üí¨</div>
	  <div>
		<div class="stat-label">Messages</div>
		<div class="stat-value">{{ stats.total_messages if stats is defined else "‚Äî" }}</div>
	  </div>
	</div>
  </div>
  <!-- Users Table -->
  <div class="card">
	<div class="toolbar">
	  <div class="toolbar-left">
		<h2 style="font-size:16px;font-weight:600;">Latest users</h2>
		<span class="badge">{{ stats.total_users if stats is defined else "" }}</span>
	  </div>
	  <a href="/export_users" class="btn-link">‚¨áÔ∏è Export Excel</a>
	</div>
	<div style="overflow-x:auto;">
	  <table class="tbl">
		<thead>
		  <tr>
			<th>user_id</th>
			<th>username</th>
			<th>first_seen</th>
			<th>last_seen</th>
			<th class="r">starts</th>
			<th class="r">msgs</th>
		  </tr>
		</thead>
		<tbody>
		  {% if users is defined and users|length > 0 %}
			{% for u in users %}
			  <tr>
				<td class="mono">{{ u.user_id }}</td>
				<td>
				  {% if u.username %}
					<span class="link">@{{ u.username }}</span>
				  {% else %}
					<span class="dim">‚Äî</span>
				  {% endif %}
				</td>
				<td class="mono dim" style="font-size:12px;">{{ u.first_seen }}</td>
				<td class="mono dim" style="font-size:12px;">{{ u.last_seen }}</td>
				<td class="r">{{ u.starts_count }}</td>
				<td class="r">{{ u.messages_count }}</td>
			  </tr>
			{% endfor %}
		  {% else %}
			<tr><td colspan="6" class="dim">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ bot –ø–∏—à–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü—É bot_users.</td></tr>
		  {% endif %}
		</tbody>
	  </table>
	</div>
  </div>
  <!-- Broadcasts -->
  <div class="card">
	<div class="card-head">
	  <span class="card-head-icon">üì°</span>
	  <div>
		<h2>Broadcasts (recurring)</h2>
		<p>–ê–≤—Ç–æ-—Ä–∞—Å—Å—ã–ª–∫–∏: –∑–∞–ø—É—Å–∫ flow –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –¥–ª—è –≤—Å–µ—Ö –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ user_id.</p>
	  </div>
	</div>
	<form method="POST" action="/add_broadcast">
	  <div class="form-row" style="flex-wrap:wrap; gap:12px;">
		<div class="form-group grow">
		  <span class="form-label">Title</span>
		  <input type="text" name="title" placeholder="Broadcast title">
		</div>
		<div class="form-group">
		  <span class="form-label">Flow</span>
		  <select name="flow">
			{% for f in flows %}
			  <option value="{{ f }}">{{ f }}</option>
			{% endfor %}
		  </select>
		</div>
		<div class="form-group">
		  <span class="form-label">Target</span>
		  <select name="target_type" id="bc_target_type" onchange="document.getElementById('bc_uid').style.display=this.value==='single'?'block':'none'">
			<option value="all">all users</option>
			<option value="single">single user_id</option>
		  </select>
		</div>
		<div class="form-group" id="bc_uid" style="display:none">
		  <span class="form-label">User ID</span>
		  <input type="number" name="target_user_id" placeholder="user_id">
		</div>
		<div class="form-group">
		  <span class="form-label">Schedule</span>
		  <select name="schedule_type" id="bc_sched" onchange="
			document.getElementById('bc_monthly').style.display=this.value==='monthly'?'flex':'none';
			document.getElementById('bc_weekly').style.display=this.value==='weekly'?'flex':'none';
			document.getElementById('bc_every').style.display=this.value==='every_n_days'?'flex':'none';
		  ">
			<option value="monthly">monthly</option>
			<option value="weekly">weekly</option>
			<option value="every_n_days">every N days</option>
		  </select>
		</div>
		<div class="form-group" id="bc_monthly">
		  <span class="form-label">Days of month</span>
		  <input type="text" name="days_of_month" placeholder="1,15" value="1,15">
		</div>
		<div class="form-group" id="bc_weekly" style="display:none">
		  <span class="form-label">Days of week</span>
		  <div class="inline gap-sm" style="flex-wrap:wrap;">
			{% for d in ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'] %}
			  <label class="weekday-btn"><input type="checkbox" name="days_of_week" value="{{ d }}" style="display:none" onchange="this.parentElement.classList.toggle('active')"> {{ d }}</label>
			{% endfor %}
		  </div>
		</div>
		<div class="form-group" id="bc_every" style="display:none">
		  <span class="form-label">Every N days</span>
		  <input type="number" name="interval_days" value="3" style="width:80px">
		</div>
		<div class="form-group">
		  <span class="form-label">At</span>
		  <div class="time-group">
			<input type="number" name="at_hour" value="10" min="0" max="23" class="time-input">
			<span class="time-sep">:</span>
			<input type="number" name="at_minute" value="00" min="0" max="59" class="time-input">
		  </div>
		</div>
		<div class="form-group" style="justify-content:flex-end;">
		  <label class="check-label">
			<input type="checkbox" name="is_active" value="1" checked>
			enabled
		  </label>
		</div>
	  </div>
	  <div style="padding:12px 20px; border-bottom:1px solid var(--border); background:rgba(26,32,41,0.3);">
		<button type="submit" class="btn btn-primary">+ Add broadcast</button>
		<p class="card-hint" style="padding:8px 0 0; border:none; background:none;">monthly: days 1,15 = 1 –∏ 15 —á–∏—Å–ª–∞. every N days: –∑–∞–ø—É—Å—Ç–∏—Ç –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∂–¥—ã–µ N –¥–Ω–µ–π.</p>
	  </div>
	</form>
	<div>
	  {% if broadcasts is defined and broadcasts|length > 0 %}
		{% for b in broadcasts %}
		  {% set b_active = (b.is_active if b.is_active is defined else 0) %}
		  {% set target = ("ALL" if b.target_user_id is not defined or b.target_user_id is none else ("user_id=" ~ b.target_user_id)) %}
		  {% set st = (b.schedule_type if b.schedule_type is defined else "monthly") %}
		  <div class="item-row">
			<div class="item-left">
			  <div class="item-title">{{ b.title if b.title is defined and b.title else ("Broadcast: " ~ b.flow) }}</div>
			  <div class="item-meta">
				flow: <span class="mono">{{ b.flow }}</span>
				‚Ä¢ target: {{ target }}
				‚Ä¢ time: {{ "%02d"|format(b.at_hour|int) }}:{{ "%02d"|format(b.at_minute|int) }}
				{% if st == "monthly" %}
				  ‚Ä¢ monthly days: {{ b.days_of_month }}
				{% elif st == "weekly" %}
				  ‚Ä¢ weekly days: {{ b.days_of_week }}
				{% else %}
				  ‚Ä¢ every: {{ b.interval_days }} days
				{% endif %}
			  </div>
			</div>
			<div class="item-actions">
			  <form method="POST" action="/toggle_broadcast/{{ b.id }}" style="display:inline">
				<button type="submit" class="pill {% if b_active|int == 1 %}pill-on{% else %}pill-off{% endif %}" style="border:none;cursor:pointer;">
				  {% if b_active|int == 1 %}ENABLED{% else %}DISABLED{% endif %}
				</button>
			  </form>
			  <form method="POST" action="/delete_broadcast/{{ b.id }}" style="display:inline" onsubmit="return confirm('Delete this broadcast?')">
				<button type="submit" class="btn btn-sm btn-danger">Delete</button>
			  </form>
			</div>
		  </div>
		{% endfor %}
	  {% else %}
		<div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Å—ã–ª–æ–∫. –î–æ–±–∞–≤—å monthly broadcast.</div>
	  {% endif %}
	</div>
  </div>
  <!-- /start Sequence -->
  <div class="card">
	<div class="card-head">
	  <span class="card-head-icon">‚ö°</span>
	  <div>
		<h2>/start sequence</h2>
		<p>–ö–∞–∫–∏–µ flow –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø–æ—Å–ª–µ /start (delay –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ /start)</p>
	  </div>
	</div>
	<div class="card-hint">–ø—Ä–∏–º–µ—Ä: welcome=0 min, day1=5 min, day2=1 day</div>
	{% for f in flows %}
	  {% set tr = (triggers[f] if (triggers is defined and f in triggers) else None) %}
	  {% set enabled = (tr.enabled if tr and tr.enabled is defined else false) %}
	  {% set unit = (tr.offset_unit if tr and tr.offset_unit is defined else "minutes") %}
	  <form method="POST" action="/save_trigger/{{ f }}">
		<div class="seq-row">
		  <div class="seq-left">
			<span class="badge" style="font-size:13px;font-weight:500;">{{ f }}</span>
			<label class="check-label">
			  <input type="checkbox" name="enabled" value="1" {% if enabled %}checked{% endif %}>
			  run after /start
			</label>
		  </div>
		  <div class="seq-right">
			<span style="font-size:12px;color:var(--text-muted);">delay</span>
			<input type="number" name="offset_value" value="{{ tr.offset_value if tr else 0 }}" style="width:70px;text-align:center;">
			<select name="offset_unit">
			  <option value="minutes" {% if unit == "minutes" %}selected{% endif %}>minutes</option>
			  <option value="hours" {% if unit == "hours" %}selected{% endif %}>hours</option>
			  <option value="days" {% if unit == "days" %}selected{% endif %}>days</option>
			</select>
			<button type="submit" class="btn btn-sm btn-primary">Save</button>
		  </div>
		</div>
	  </form>
	{% endfor %}
  </div>
  <!-- After Flow ‚Üí Start Flow -->
  <div class="card">
	<div class="card-head">
	  <span class="card-head-icon">üîÄ</span>
	  <div>
		<h2>After flow ‚Üí start flow</h2>
		<p>–ü—Ä–∞–≤–∏–ª–∞: –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è flow A –∑–∞–ø—É—Å—Ç–∏—Ç—å flow B —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É (welcome ‚Üí day1 –∏ —Ç.–¥.)</p>
	  </div>
	</div>
	<form method="POST" action="/add_action">
	  <div class="form-row">
		<div class="form-group">
		  <span class="form-label">After</span>
		  <select name="after_flow">
			{% for f in flows %}<option value="{{ f }}">{{ f }}</option>{% endfor %}
		  </select>
		</div>
		<div class="form-group">
		  <span class="form-label">start</span>
		  <select name="target_flow">
			{% for f in flows %}<option value="{{ f }}">{{ f }}</option>{% endfor %}
		  </select>
		</div>
		<div class="form-group">
		  <span class="form-label">after</span>
		  <div class="inline">
			<input type="number" name="delay_value" value="5" style="width:70px">
			<select name="delay_unit">
			  <option value="seconds">seconds</option>
			  <option value="minutes">minutes</option>
			  <option value="hours">hours</option>
			  <option value="days">days</option>
			</select>
		  </div>
		</div>
		<div class="form-group" style="justify-content:flex-end;">
		  <button type="submit" class="btn btn-primary">+ Add rule</button>
		</div>
	  </div>
	  <div class="card-hint">–ø—Ä–∏–º–µ—Ä: After welcome start day1 after 5 minutes</div>
	</form>
	<div>
	  {% if actions is defined and actions|length > 0 %}
		{% for a in actions %}
		  {% set a_active = (a.is_active if a.is_active is defined else 0) %}
		  <div class="item-row">
			<div class="inline" style="gap:10px;">
			  <span class="badge" style="font-size:13px;font-weight:500;">{{ a.after_flow }}</span>
			  <span class="chain-arrow">‚Üí</span>
			  <span class="badge" style="font-size:13px;font-weight:500;">{{ a.target_flow }}</span>
			  <span style="font-size:12px;color:var(--text-muted);margin-left:8px;">delay: {{ a.delay_seconds }}s</span>
			</div>
			<div class="item-actions">
			  <form method="POST" action="/toggle_action/{{ a.id }}" style="display:inline">
				<button type="submit" class="pill {% if a_active|int == 1 %}pill-on{% else %}pill-off{% endif %}" style="border:none;cursor:pointer;">
				  {% if a_active|int == 1 %}ENABLED{% else %}DISABLED{% endif %}
				</button>
			  </form>
			  <form method="POST" action="/delete_action/{{ a.id }}" style="display:inline" onsubmit="return confirm('Delete this rule?')">
				<button type="submit" class="btn btn-sm btn-danger">Delete</button>
			  </form>
			</div>
		  </div>
		{% endfor %}
	  {% else %}
		<div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∞–≤–∏–ª. –î–æ–±–∞–≤—å welcome ‚Üí day1.</div>
	  {% endif %}
	</div>
  </div>
  <!-- Flows -->
  <div class="card">
	<div class="card-head">
	  <span class="card-head-icon">üì¶</span>
	  <div>
		<h2>Flows</h2>
		<p>–ü–æ—Ä—è–¥–æ–∫ flow –º–µ–Ω—è–µ—Ç—Å—è ‚Üë/‚Üì. –£–¥–∞–ª–µ–Ω–∏–µ ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ (—Å–æ—Ç—Ä—ë—Ç –±–ª–æ–∫–∏).</p>
	  </div>
	</div>
	<form method="POST" action="/add_flow" class="form-row">
	  <div class="form-group grow">
		<input type="text" name="flow_name" placeholder="New flow name">
	  </div>
	  <div class="form-group" style="justify-content:flex-end;">
		<button type="submit" class="btn btn-primary">+ New flow</button>
	  </div>
	</form>
	{% for f in flows %}
	  {% set tr = (triggers[f] if (triggers is defined and f in triggers) else None) %}
	  {% set mode = (tr.mode if tr and tr.mode is defined else "off") %}
	  {% set enabled = (tr.enabled if tr and tr.enabled is defined else false) %}
	  <div>
		<div class="flow-header" onclick="var d=document.getElementById('flow-detail-{{ loop.index }}');d.style.display=d.style.display==='none'?'block':'none';">
		  <div class="inline" style="gap:10px;">
			<span class="flow-name">{{ f }}</span>
			<span class="pill {% if mode == 'auto' %}pill-auto{% elif mode == 'manual' %}pill-manual{% else %}pill-off{% endif %}">
			  {{ mode|upper }}
			</span>
			<a href="/flow/{{ f }}" class="btn-link" style="font-size:12px;" onclick="event.stopPropagation();">open ‚Üí</a>
		  </div>
		  <div class="flow-controls">
			<form method="POST" action="/move_flow/{{ f }}/up" style="display:inline" onclick="event.stopPropagation();">
			  <button type="submit" class="flow-btn">‚Üë</button>
			</form>
			<form method="POST" action="/move_flow/{{ f }}/down" style="display:inline" onclick="event.stopPropagation();">
			  <button type="submit" class="flow-btn">‚Üì</button>
			</form>
			<form method="POST" action="/delete_flow/{{ f }}" style="display:inline" onclick="event.stopPropagation();" onsubmit="return confirm('Delete flow {{ f }}?')">
			  <button type="submit" class="flow-btn del">üóë</button>
			</form>
		  </div>
		</div>
		<div id="flow-detail-{{ loop.index }}" class="flow-detail" style="display:none;">
		  <div class="flow-detail-inner">
			<h4>Delivery mode</h4>
			<form method="POST" action="/save_flow_mode/{{ f }}">
			  <div class="row" style="display:flex;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:12px;">
				<span style="font-size:12px;color:var(--text-muted);">Mode</span>
				<select name="mode">
				  <option value="off" {% if mode == "off" %}selected{% endif %}>off</option>
				  <option value="manual" {% if mode == "manual" %}selected{% endif %}>manual</option>
				  <option value="auto" {% if mode == "auto" %}selected{% endif %}>auto</option>
				</select>
				<button type="submit" class="btn btn-sm btn-primary">Save</button>
			  </div>
			</form>
			<form method="POST" action="/save_flow_auto/{{ f }}">
			  <div style="border-top:1px solid var(--border);padding-top:12px;">
				<h4>Auto-send after /start</h4>
				<div class="row" style="display:flex;align-items:center;flex-wrap:wrap;gap:8px;">
				  <input type="number" name="offset_value" value="{{ tr.offset_value if tr else 0 }}" style="width:70px;text-align:center;">
				  {% set unit2 = (tr.offset_unit if tr and tr.offset_unit is defined else "days") %}
				  <select name="offset_unit">
					<option value="minutes" {% if unit2 == "minutes" %}selected{% endif %}>minutes</option>
					<option value="hours" {% if unit2 == "hours" %}selected{% endif %}>hours</option>
					<option value="days" {% if unit2 == "days" %}selected{% endif %}>days</option>
				  </select>
				  <label class="check-label">
					<input type="checkbox" name="enabled" value="1" {% if enabled %}checked{% endif %}>
					enabled
				  </label>
				  <button type="submit" class="btn btn-sm btn-primary">Save</button>
				</div>
				<p style="font-size:11px;color:var(--text-muted);margin-top:8px;">–ü—Ä–∏–º–µ—Ä: day2 ‚Üí 1 days, day3 ‚Üí 2 days.</p>
			  </div>
			</form>
		  </div>
		</div>
	  </div>
	{% endfor %}
	{% if flows|length == 0 %}
	  <div class="empty">–ù–µ—Ç flows. –ó–∞–ø—É—Å—Ç–∏ seed.py.</div>
	{% endif %}
  </div>
</div>
{% endblock %}