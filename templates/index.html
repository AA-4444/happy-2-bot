{% extends "base.html" %}
{% block content %}

<!-- ===================== TABS NAV ===================== -->
<div class="mb-8">
  <div class="flex gap-2 border-b border-white/10 pb-3 text-sm">
	<button class="tab-btn active" data-tab="dashboard">üìä Dashboard</button>
	<button class="tab-btn" data-tab="broadcasts">üì¢ Broadcasts</button>
	<button class="tab-btn" data-tab="automation">üîÅ Automation</button>
	<button class="tab-btn" data-tab="flows">üß± Flows</button>
  </div>
</div>


<!-- ===================== DASHBOARD ===================== -->
<div data-tab-content="dashboard" class="tab-content">

  <!-- STATS -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
	<div class="card-stat">
	  <div class="stat-label">Users</div>
	  <div class="stat-value">{{ stats.total_users if stats else "-" }}</div>
	</div>
	<div class="card-stat">
	  <div class="stat-label">Active (1h)</div>
	  <div class="stat-value">{{ stats.active_last_hour if stats else "-" }}</div>
	</div>
	<div class="card-stat">
	  <div class="stat-label">/start</div>
	  <div class="stat-value">{{ stats.total_starts if stats else "-" }}</div>
	</div>
	<div class="card-stat">
	  <div class="stat-label">Messages</div>
	  <div class="stat-value">{{ stats.total_messages if stats else "-" }}</div>
	</div>
  </div>

  <!-- USERS TABLE -->
  <div class="card">
	<div class="card-header">
	  <div class="font-medium">Latest users</div>
	  <a href="/export/users.xlsx" class="btn-secondary">‚¨áÔ∏è Export Excel</a>
	</div>

	<div class="overflow-x-auto">
	  <table class="w-full text-sm">
		<thead class="text-white/50">
		  <tr class="border-b border-white/10">
			<th class="text-left py-2">user_id</th>
			<th class="text-left py-2">username</th>
			<th class="text-left py-2">first_seen</th>
			<th class="text-left py-2">last_seen</th>
			<th class="text-left py-2">starts</th>
			<th class="text-left py-2">msgs</th>
		  </tr>
		</thead>
		<tbody class="text-white/80">
		  {% if users %}
			{% for u in users %}
			<tr class="border-b border-white/5 hover:bg-white/[0.03]">
			  <td class="py-2">{{ u.user_id }}</td>
			  <td class="py-2">@{{ u.username or "‚Äî" }}</td>
			  <td class="py-2 text-white/60">{{ u.first_seen }}</td>
			  <td class="py-2 text-white/60">{{ u.last_seen }}</td>
			  <td class="py-2">{{ u.starts_count }}</td>
			  <td class="py-2">{{ u.messages_count }}</td>
			</tr>
			{% endfor %}
		  {% else %}
			<tr><td colspan="6" class="py-4 text-white/40">No users yet</td></tr>
		  {% endif %}
		</tbody>
	  </table>
	</div>
  </div>
</div>



<!-- ===================== BROADCASTS ===================== -->
<div data-tab-content="broadcasts" class="tab-content hidden">

  <div class="card mb-8">
	<div class="card-title">Create scheduled campaign</div>

	<form method="post" action="/broadcast/new" class="space-y-6 mt-6">

	  <div>
		<label class="label">Title</label>
		<input type="text" name="title" class="input w-full">
	  </div>

	  <div>
		<label class="label">Flow</label>
		<select name="flow" class="input w-full">
		  {% for f in flows %}
		  <option value="{{ f }}">{{ f }}</option>
		  {% endfor %}
		</select>
	  </div>

	  <div>
		<label class="label">Target</label>
		<select name="target_mode" class="input w-full" data-bc-target>
		  <option value="all">All users</option>
		  <option value="user">Single user_id</option>
		</select>
		<input type="number" name="target_user_id"
			   placeholder="user_id"
			   class="input w-full mt-2 hidden"
			   data-bc-userid>
	  </div>

	  <div>
		<label class="label">Schedule type</label>
		<select name="schedule_type" class="input w-full" data-bc-schedule>
		  <option value="weekly">Weekly</option>
		  <option value="monthly">Monthly</option>
		  <option value="interval_days">Every N days</option>
		</select>
	  </div>

	  <div data-bc-dow class="hidden">
		<label class="label">Days of week</label>
		<div class="flex gap-3 text-sm">
		  <label><input type="checkbox" value="0" class="dow-cb">Mon</label>
		  <label><input type="checkbox" value="1" class="dow-cb">Tue</label>
		  <label><input type="checkbox" value="2" class="dow-cb">Wed</label>
		  <label><input type="checkbox" value="3" class="dow-cb">Thu</label>
		  <label><input type="checkbox" value="4" class="dow-cb">Fri</label>
		  <label><input type="checkbox" value="5" class="dow-cb">Sat</label>
		  <label><input type="checkbox" value="6" class="dow-cb">Sun</label>
		</div>
		<input type="hidden" name="days_of_week" value="0" data-bc-dow-hidden>
	  </div>

	  <div data-bc-dom class="hidden">
		<label class="label">Days of month (1..31)</label>
		<input type="text" name="days_of_month" class="input w-full">
	  </div>

	  <div data-bc-interval class="hidden">
		<label class="label">Interval (days)</label>
		<input type="number" name="interval_days" value="30" class="input w-full">
	  </div>

	  <div class="grid grid-cols-2 gap-4">
		<div>
		  <label class="label">Hour</label>
		  <input type="number" name="at_hour" class="input w-full">
		</div>
		<div>
		  <label class="label">Minute</label>
		  <input type="number" name="at_minute" class="input w-full">
		</div>
	  </div>

	  <label class="flex items-center gap-2">
		<input type="checkbox" name="is_active" value="1" checked>
		Enable campaign
	  </label>

	  <button class="btn-primary w-full">Create campaign</button>
	</form>
  </div>

  <!-- LIST -->
  <div class="space-y-3">
	{% for b in broadcasts %}
	<div class="card flex justify-between items-center">
	  <div>
		<div class="font-medium">{{ b.title or b.flow }}</div>
		<div class="text-xs text-white/50">
		  {{ b.schedule_type }} ‚Ä¢ {{ "%02d"|format(b.at_hour) }}:{{ "%02d"|format(b.at_minute) }}
		</div>
	  </div>

	  <div class="flex gap-2">
		<form method="post" action="/broadcast/{{ b.id }}/toggle">
		  <input type="hidden" name="is_active" value="{% if b.is_active %}0{% else %}1{% endif %}">
		  <button class="btn-secondary">
			{% if b.is_active %}Disable{% else %}Enable{% endif %}
		  </button>
		</form>

		<form method="post" action="/broadcast/{{ b.id }}/delete">
		  <button class="btn-danger">Delete</button>
		</form>
	  </div>
	</div>
	{% endfor %}
  </div>

</div>



<!-- ===================== AUTOMATION ===================== -->
<div data-tab-content="automation" class="tab-content hidden">

  <div class="card mb-8">
	<div class="card-title">Auto start after /start</div>

	<div class="space-y-3 mt-6">
	  {% for f in flows %}
	  {% set tr = triggers[f] if triggers and f in triggers else None %}
	  <form method="post" action="/flow/{{ f }}/trigger" class="flex gap-3 items-center">
		<div class="w-32 font-medium">{{ f }}</div>

		<select name="mode" class="input">
		  <option value="off">off</option>
		  <option value="manual">manual</option>
		  <option value="auto" {% if tr and tr.mode=="auto" %}selected{% endif %}>auto</option>
		</select>

		<input type="number" name="offset_value"
			   value="{{ tr.offset_value if tr else 0 }}"
			   class="input w-20">

		<select name="offset_unit" class="input">
		  <option value="minutes">minutes</option>
		  <option value="hours">hours</option>
		  <option value="days">days</option>
		</select>

		<label class="flex items-center gap-2 text-sm">
		  <input type="checkbox" name="enabled" value="1"
				 {% if tr and tr.enabled %}checked{% endif %}>
		  enabled
		</label>

		<button class="btn-secondary">Save</button>
	  </form>
	  {% endfor %}
	</div>
  </div>

</div>



<!-- ===================== FLOWS ===================== -->
<div data-tab-content="flows" class="tab-content hidden">

  <div class="flex justify-between mb-6">
	<div class="text-lg font-medium">Flows</div>
	<form method="post" action="/flow/new" class="flex gap-2">
	  <input type="text" name="name" class="input">
	  <button class="btn-primary">Add</button>
	</form>
  </div>

  <div class="grid md:grid-cols-2 gap-4">
	{% for f in flows %}
	<div class="card flex justify-between items-center">
	  <div class="font-medium">{{ f }}</div>
	  <div class="flex gap-2">
		<a href="/flow/{{ f }}" class="btn-secondary">Open</a>
		<form method="post" action="/flow/{{ f }}/delete">
		  <button class="btn-danger">Delete</button>
		</form>
	  </div>
	</div>
	{% endfor %}
  </div>

</div>



<!-- ===================== STYLES ===================== -->
<style>
.card { @apply rounded-2xl border border-white/10 bg-white/[0.02] p-6; }
.card-title { @apply text-base font-medium; }
.card-header { @apply flex justify-between items-center mb-4; }
.card-stat { @apply rounded-xl border border-white/10 bg-white/[0.02] p-4; }
.stat-label { @apply text-xs text-white/40; }
.stat-value { @apply text-xl font-semibold; }
.input { @apply px-3 py-2 rounded-xl bg-black/40 border border-white/10 text-sm; }
.label { @apply text-xs text-white/60 mb-1 block; }
.btn-primary { @apply px-4 py-2 rounded-xl bg-white text-black text-sm font-medium hover:opacity-90; }
.btn-secondary { @apply px-3 py-2 rounded-xl bg-white/10 border border-white/10 text-sm hover:bg-white/15; }
.btn-danger { @apply px-3 py-2 rounded-xl bg-red-500/10 border border-red-500/20 text-red-200 text-sm; }
.hidden { display:none; }
.tab-btn { @apply px-4 py-2 rounded-lg hover:bg-white/5; }
.tab-btn.active { @apply bg-white/10; }
</style>



<!-- ===================== TABS SCRIPT ===================== -->
<script>
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
	document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
	btn.classList.add('active');
	const tab = btn.dataset.tab;
	document.querySelectorAll('[data-tab-content]').forEach(c=>{
	  c.classList.add('hidden');
	  if(c.dataset.tabContent===tab){
		c.classList.remove('hidden');
	  }
	});
  });
});
</script>

{% endblock %}