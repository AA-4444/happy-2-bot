{# templates/edit.html #}
{% extends "base.html" %}
{% block content %}

<style>
  /* Edit page ‚Äî works WITH base.html variables */
  .edit-header {
	display:flex; align-items:center; justify-content:space-between;
	margin-bottom:24px;
  }
  .edit-header h1 { font-size:18px; font-weight:600; }

  .field-label {
	font-size:11px; color:var(--muted); text-transform:uppercase;
	letter-spacing:0.04em; font-weight:600; display:block; margin-bottom:6px;
  }
  .field-hint { font-size:11px; color:var(--muted2); margin-top:5px; }

  /* Override base.html input sizing */
  .edit-form input[type="text"],
  .edit-form input[type="number"],
  .edit-form select {
	width:100% !important;
	height:40px !important;
	padding:0 12px !important;
	font-size:14px !important;
  }
  .edit-form textarea {
	width:100% !important;
	min-height:140px !important;
	padding:12px !important;
	font-size:14px !important;
	line-height:1.6 !important;
	resize:vertical !important;
  }
  .edit-form input[type="file"] {
	border:none !important;
	background:none !important;
	height:auto !important;
	padding:0 !important;
	color:var(--muted) !important;
	font-size:13px !important;
  }
  .edit-form input[type="checkbox"] {
	width:16px !important;
	height:16px !important;
	border:none !important;
	background:none !important;
  }

  .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
  .grid-2 { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; }
  @media(max-width:768px){
	.grid-3, .grid-2 { grid-template-columns:1fr; }
  }

  .section-panel {
	background:var(--panel2);
	border:1px solid var(--border);
	border-radius:16px;
	padding:24px;
	margin-top:20px;
  }
  .section-head {
	display:flex; align-items:center; justify-content:space-between;
	margin-bottom:16px;
  }
  .section-title {
	font-size:15px; font-weight:600;
	display:flex; align-items:center; gap:8px;
  }
  .section-title i { font-size:14px; color:var(--muted); }
  .section-subtitle { font-size:12px; color:var(--muted2); }

  .field-group { margin-bottom:16px; }
  .field-group:last-child { margin-bottom:0; }

  .error-box {
	background:var(--dangerBg);
	border:1px solid var(--dangerBorder);
	border-radius:12px;
	padding:12px 16px;
	font-size:13px;
	color:var(--dangerFg);
	margin-bottom:20px;
	display:flex; align-items:center; gap:8px;
  }

  .btn-edit {
	display:inline-flex; align-items:center; gap:7px;
	height:40px; padding:0 18px; border-radius:12px;
	font-size:14px; font-weight:500; cursor:pointer;
	transition:all .15s; white-space:nowrap;
  }
  .btn-edit i { font-size:12px; }
 .btn-edit-primary {
   background:var(--primary) !important;
   color:var(--primaryFg) !important;
   border:none !important;
 }
  .btn-edit-primary:hover { opacity:.88; }
  .btn-edit-outline {
	background:var(--btnBg) !important;
	color:var(--fg) !important;
	border:1px solid var(--btnBorder) !important;
  }
  .btn-edit-outline:hover { background:var(--btnHover) !important; }
  .btn-edit-link {
	background:none !important; border:none !important;
	color:var(--muted) !important; font-size:13px;
	display:inline-flex; align-items:center; gap:6px;
	cursor:pointer; padding:0;
  }
  .btn-edit-link:hover { color:var(--fg) !important; }

  .check-label {
	display:inline-flex; align-items:center; gap:7px;
	font-size:13px; color:var(--muted); cursor:pointer;
  }

  .delay-preview {
	font-size:12px; color:var(--muted2); margin-top:6px;
  }
  .delay-preview code { color:var(--fg); }

  details summary {
	cursor:pointer; font-size:12px; color:var(--muted2);
	padding:4px 0;
  }
</style>

<div class="edit-form">

  <!-- Header -->
  <div class="edit-header">
	<h1>
	  <i class="fa-solid fa-pen-to-square" style="font-size:16px;color:var(--muted);margin-right:6px;"></i>
	  {{ "New block" if is_new else "Edit block" }}
	</h1>
	<a href="/flow/{{ block.get('flow','') }}" class="btn-edit-link">
	  <i class="fa-solid fa-arrow-left" style="font-size:11px;"></i> back
	</a>
  </div>

  {% if error %}
	<div class="error-box">
	  <i class="fa-solid fa-circle-exclamation"></i> {{ error }}
	</div>
  {% endif %}

  <form method="post" action="/block/save" enctype="multipart/form-data">
	<input type="hidden" name="block_id" value="{{ block.get('id', 0) }}" />
	<input type="hidden" name="file_path" value="{{ block.get('file_path','') }}" />
	<input type="hidden" name="file_kind" value="{{ block.get('file_kind','') }}" />
	<input type="hidden" name="file_name" value="{{ block.get('file_name','') }}" />
	<input type="hidden" id="delaySeconds" name="delay_seconds" value="{{ block.get('delay', 1.0) }}" />

	<!-- Basic fields -->
	<div class="section-panel">
	  <div class="section-head">
		<div class="section-title"><i class="fa-solid fa-sliders"></i> Basic settings</div>
	  </div>

	  <div class="grid-3 field-group">
		<div>
		  <label class="field-label"><i class="fa-solid fa-diagram-project" style="margin-right:4px;"></i> Flow</label>
		  <input name="flow" type="text" value="{{ block.get('flow','') }}" />
		</div>
		<div>
		  <label class="field-label"><i class="fa-solid fa-list-ol" style="margin-right:4px;"></i> Position</label>
		  <input name="position" type="number" value="{{ block.get('position', 1) }}" />
		</div>
		<div>
		  <label class="field-label"><i class="fa-solid fa-shapes" style="margin-right:4px;"></i> Type</label>
		  <select id="typeSel" name="type">
			{% set cur_type = block.get('type','text') %}
			{% for t in ["text","circle","video","buttons"] %}
			  <option value="{{ t }}" {% if cur_type == t %}selected{% endif %}>{{ t }}</option>
			{% endfor %}
		  </select>
		</div>
	  </div>

	  <div class="grid-3 field-group">
		<div>
		  <label class="field-label"><i class="fa-solid fa-heading" style="margin-right:4px;"></i> Title <span style="font-weight:400;text-transform:none;">(–¥–ª—è video/buttons)</span></label>
		  <input name="title" type="text" value="{{ block.get('title','') }}" />
		</div>
		<div>
		  <label class="field-label"><i class="fa-solid fa-clock" style="margin-right:4px;"></i> Delay</label>
		  <div class="field-hint" style="margin-top:-2px;margin-bottom:8px;">–º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –º–∏–Ω—É—Ç—ã/—á–∞—Å—ã/–¥–Ω–∏ (–≤ –±–∞–∑—É —É–π–¥—ë—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö)</div>
		  <div style="display:flex;align-items:center;gap:8px;">
			<input id="delayValue" type="number" min="0" step="1" value="" placeholder="1" style="width:80px!important;flex:none!important;" />
			<select id="delayUnit" style="width:auto!important;flex:none!important;">
			  <option value="seconds">seconds</option>
			  <option value="minutes">minutes</option>
			  <option value="hours">hours</option>
			  <option value="days">days</option>
			</select>
			<button type="button" class="btn-edit btn-edit-outline" onclick="applyDelayToSeconds()" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å delay ‚Üí delay_seconds" style="height:36px;padding:0 12px;">
			  <i class="fa-solid fa-rotate"></i> Apply
			</button>
		  </div>
		  <div class="delay-preview">
			–°–µ–π—á–∞—Å: <code id="delaySecondsPreview">{{ block.get('delay', 1.0) }}</code> sec
		  </div>
		</div>
		<div>
		  <label class="field-label"><i class="fa-solid fa-toggle-on" style="margin-right:4px;"></i> is_active (0/1)</label>
		  <input name="is_active" type="number" value="{{ block.get('is_active', 1) }}" />
		</div>
	  </div>
	</div>

	<!-- TEXT -->
	<div class="section-panel" id="secText">
	  <div class="section-head">
		<div class="section-title"><i class="fa-solid fa-align-left"></i> Text</div>
	  </div>
	  <textarea name="text" rows="6">{{ block.get('text','') }}</textarea>
	</div>

	<!-- MEDIA -->
	<div class="section-panel" id="secMedia">
	  <div class="section-head">
		<div class="section-title"><i class="fa-solid fa-photo-film"></i> Media</div>
	  </div>
	  <div class="grid-2">
		<div>
		  <label class="field-label"><i class="fa-solid fa-circle-play" style="margin-right:4px;"></i> circle_path (–∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª)</label>
		  <input name="circle_path" type="text" value="{{ block.get('circle','') }}" />
		  <div style="margin-top:10px;">
			<input type="file" name="circle_file" />
		  </div>
		  {% if block.get('circle') %}
			<div class="field-hint"><i class="fa-solid fa-file" style="margin-right:4px;"></i> current: {{ block.get('circle') }}</div>
		  {% endif %}
		</div>
		<div>
		  <label class="field-label"><i class="fa-solid fa-video" style="margin-right:4px;"></i> video_url</label>
		  <input name="video_url" type="text" value="{{ block.get('video','') }}" />
		</div>
	  </div>
	</div>

	<!-- ATTACHMENT -->
	<div class="section-panel">
	  <div class="section-head">
		<div class="section-title"><i class="fa-solid fa-paperclip"></i> Attachment</div>
		<span class="section-subtitle">–ª—é–±–æ–π —Ñ–∞–π–ª (pdf/docx/png/zip –∏ —Ç.–¥.)</span>
	  </div>
	  <div class="grid-2">
		<div>
		  <label class="field-label"><i class="fa-solid fa-upload" style="margin-right:4px;"></i> Upload file</label>
		  <input type="file" name="attach_file" />
		  <div class="field-hint">
			–ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏—à—å ‚Äî —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ <code>media/</code> –∏ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –±–æ—Ç–æ–º –≤ —ç—Ç–æ–º –±–ª–æ–∫–µ.
		  </div>
		</div>
		<div>
		  <label class="field-label"><i class="fa-solid fa-file-circle-check" style="margin-right:4px;"></i> Current</label>
		  <div style="margin-top:4px;font-size:13px;">
			{% if block.get('file_path') %}
			  <div class="field-hint" style="margin-top:0;">kind: {{ block.get('file_kind','') }}</div>
			  <a style="color:var(--fg);text-decoration:underline;" href="{{ block.get('file_path') }}" target="_blank">
				<i class="fa-solid fa-arrow-up-right-from-square" style="font-size:10px;margin-right:4px;"></i>{{ block.get('file_path') }}
			  </a>
			{% else %}
			  <span style="color:var(--muted2);">‚Äî</span>
			{% endif %}
		  </div>
		  <div style="margin-top:12px;">
			<button type="button" class="btn-edit btn-edit-outline" style="height:34px;padding:0 12px;" onclick="clearAttachment()">
			  <i class="fa-solid fa-xmark"></i> Clear attachment
			</button>
		  </div>
		</div>
	  </div>
	</div>

	<!-- NEXT LESSON GATE -->
	<div class="section-panel">
	  <div class="section-head">
		<div class="section-title"><i class="fa-solid fa-door-open"></i> Next lesson gate</div>
		<span class="section-subtitle">–∫–Ω–æ–ø–∫–∞ "–ì–æ—Ç–æ–≤‚Ä¶" + –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</span>
	  </div>
	  <div class="field-hint" style="margin-bottom:16px;">
		–ï—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å <b>Next flow</b> ‚Äî –±–æ—Ç –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∏ –ø–æ–∫–∞–∂–µ—Ç –∫–Ω–æ–ø–∫—É.
		–ü–æ –Ω–∞–∂–∞—Ç–∏—é ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π flow.
	  </div>

	  <div class="grid-2 field-group">
		<div>
		  <label class="field-label"><i class="fa-solid fa-forward" style="margin-right:4px;"></i> Next flow (—á—Ç–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ—Å–ª–µ –∫–Ω–æ–ø–∫–∏)</label>
		  {% if flows is defined and flows %}
			<select name="gate_next_flow">
			  <option value="">‚Äî disabled ‚Äî</option>
			  {% for f in flows %}
				<option value="{{ f }}" {% if block.get('gate_next_flow','') == f %}selected{% endif %}>{{ f }}</option>
			  {% endfor %}
			</select>
		  {% else %}
			<input name="gate_next_flow" type="text" value="{{ block.get('gate_next_flow','') }}" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: day2" />
			<div class="field-hint">
			  (—á—Ç–æ–±—ã –±—ã–ª dropdown ‚Äî –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å <code>flows</code> –≤ —à–∞–±–ª–æ–Ω –∏–∑ crm.py)
			</div>
		  {% endif %}
		</div>
		<div>
		  <label class="field-label"><i class="fa-solid fa-square-check" style="margin-right:4px;"></i> Button text</label>
		  <input name="gate_button_text" type="text" value="{{ block.get('gate_button_text') or '‚úÖ –ì–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É—Ä–æ–∫—É' }}" />
		</div>
	  </div>

	  <div class="field-group">
		<label class="field-label"><i class="fa-solid fa-message" style="margin-right:4px;"></i> Text above button (editable)</label>
		<input name="gate_prompt_text" type="text" value="{{ block.get('gate_prompt_text','') }}" placeholder="üëá –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—å—à–µ" />
		<div class="field-hint">–ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –±–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç.</div>
	  </div>

	  <div class="grid-3 field-group">
		<div>
		  <label class="field-label"><i class="fa-solid fa-bell" style="margin-right:4px;"></i> Reminder</label>
		  <input name="gate_reminder_value" type="number" min="0" value="{{ block.get('gate_reminder_value', 0) }}" placeholder="0" />
		  <div class="field-hint">0 = –±–µ–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</div>
		</div>
		<div>
		  <label class="field-label"><i class="fa-solid fa-stopwatch" style="margin-right:4px;"></i> Unit</label>
		  {% set u = (block.get('gate_reminder_unit') or 'hours') %}
		  <select name="gate_reminder_unit">
			<option value="minutes" {% if u=='minutes' %}selected{% endif %}>minutes</option>
			<option value="hours" {% if u=='hours' %}selected{% endif %}>hours</option>
			<option value="days" {% if u=='days' %}selected{% endif %}>days</option>
		  </select>
		</div>
		<div>
		  <label class="field-label"><i class="fa-solid fa-comment-dots" style="margin-right:4px;"></i> Reminder text (optional)</label>
		  <input name="gate_reminder_text" type="text" value="{{ block.get('gate_reminder_text','') }}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢—ã –≥–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? üôÇ" />
		</div>
	  </div>

	  <div style="display:flex;align-items:center;gap:12px;">
		<button type="button" class="btn-edit btn-edit-outline" style="height:34px;padding:0 12px;" onclick="clearGate()">
		  <i class="fa-solid fa-ban"></i> Disable gate
		</button>
		<span class="field-hint" style="margin-top:0;">Disabled = –ø–æ–ª–µ Next flow —Å—Ç–∞–Ω–µ—Ç –ø—É—Å—Ç—ã–º (gate –≤—ã–∫–ª—é—á–µ–Ω).</span>
	  </div>
	</div>

	<!-- BUTTONS EASY MODE -->
	<div class="section-panel" id="secButtons">
	  <div class="section-head">
		<div class="section-title"><i class="fa-solid fa-grip"></i> Buttons</div>
		<span class="section-subtitle">–¥–æ 3 –∫–Ω–æ–ø–æ–∫</span>
	  </div>
	  <div class="grid-2 field-group">
		<div>
		  <label class="field-label">Button 1 text</label>
		  <input name="btn1_text" type="text" value="{{ block.get('btn1_text','') }}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç" />
		</div>
		<div>
		  <label class="field-label">Button 1 url</label>
		  <input name="btn1_url" type="text" value="{{ block.get('btn1_url','') }}" placeholder="https://..." />
		</div>
		<div>
		  <label class="field-label">Button 2 text</label>
		  <input name="btn2_text" type="text" value="{{ block.get('btn2_text','') }}" placeholder="(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
		</div>
		<div>
		  <label class="field-label">Button 2 url</label>
		  <input name="btn2_url" type="text" value="{{ block.get('btn2_url','') }}" placeholder="https://..." />
		</div>
		<div>
		  <label class="field-label">Button 3 text</label>
		  <input name="btn3_text" type="text" value="{{ block.get('btn3_text','') }}" placeholder="(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
		</div>
		<div>
		  <label class="field-label">Button 3 url</label>
		  <input name="btn3_url" type="text" value="{{ block.get('btn3_url','') }}" placeholder="https://..." />
		</div>
	  </div>
	  <details>
		<summary><i class="fa-solid fa-code" style="margin-right:4px;font-size:11px;"></i> Advanced (JSON)</summary>
		<textarea name="buttons_json" rows="4" style="margin-top:8px;">{{ block.get('buttons_json','') or block.get('buttons','') }}</textarea>
		<div class="field-hint">–ï—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω JSON. –ò–Ω–∞—á–µ –±–µ—Ä—ë–º –∫–Ω–æ–ø–∫–∏ —Å–≤–µ—Ä—Ö—É.</div>
	  </details>
	</div>

	<!-- Save -->
	<div style="margin-top:24px;">
	  <button type="submit" class="btn-edit btn-edit-primary">
		<i class="fa-solid fa-floppy-disk"></i> Save
	  </button>
	</div>
  </form>
</div>

<script>
  function toggleSections() {
	const secButtons = document.getElementById("secButtons");
	if (secButtons) {
	  secButtons.style.display = "block";
	  secButtons.style.opacity = "1";
	  secButtons.style.pointerEvents = "auto";
	  secButtons.querySelectorAll("input, textarea").forEach(i => i.disabled = false);
	}
  }
  function clearAttachment() {
	const fp = document.querySelector('input[name="file_path"]');
	const fk = document.querySelector('input[name="file_kind"]');
	const fn = document.querySelector('input[name="file_name"]');
	if (fp) fp.value = '';
	if (fk) fk.value = '';
	if (fn) fn.value = '';
	alert('Attachment –æ—á–∏—â–µ–Ω. –ù–∞–∂–º–∏ Save.');
  }
  function clearGate() {
	const nf = document.querySelector('[name="gate_next_flow"]');
	const bt = document.querySelector('[name="gate_button_text"]');
	const gp = document.querySelector('[name="gate_prompt_text"]');
	const rv = document.querySelector('[name="gate_reminder_value"]');
	const ru = document.querySelector('[name="gate_reminder_unit"]');
	const rt = document.querySelector('[name="gate_reminder_text"]');
	if (nf) nf.value = '';
	if (bt) bt.value = '';
	if (gp) gp.value = '';
	if (rv) rv.value = '0';
	if (ru) ru.value = 'hours';
	if (rt) rt.value = '';
	alert('Gate –æ—Ç–∫–ª—é—á—ë–Ω. –ù–∞–∂–º–∏ Save.');
  }
  function unitToSeconds(unit) {
	const u = (unit || '').toLowerCase();
	if (u === 'minutes') return 60;
	if (u === 'hours') return 3600;
	if (u === 'days') return 86400;
	return 1;
  }
  function secondsToValueUnit(sec) {
	const s = Math.max(0, Math.floor(Number(sec || 0)));
	if (s === 0) return { value: 0, unit: 'seconds' };
	if (s % 86400 === 0) return { value: s / 86400, unit: 'days' };
	if (s % 3600 === 0) return { value: s / 3600, unit: 'hours' };
	if (s % 60 === 0) return { value: s / 60, unit: 'minutes' };
	return { value: s, unit: 'seconds' };
  }
  function applyDelayToSeconds() {
	const vEl = document.getElementById('delayValue');
	const uEl = document.getElementById('delayUnit');
	const sEl = document.getElementById('delaySeconds');
	const pEl = document.getElementById('delaySecondsPreview');
	const v = Math.max(0, Math.floor(Number((vEl && vEl.value) || 0)));
	const u = (uEl && uEl.value) || 'seconds';
	const sec = v * unitToSeconds(u);
	if (sEl) sEl.value = String(sec);
	if (pEl) pEl.textContent = String(sec);
  }
  function initDelayUI() {
	const sEl = document.getElementById('delaySeconds');
	const vEl = document.getElementById('delayValue');
	const uEl = document.getElementById('delayUnit');
	const pEl = document.getElementById('delaySecondsPreview');
	const sec = Number((sEl && sEl.value) || 0);
	const vu = secondsToValueUnit(sec);
	if (vEl) vEl.value = String(vu.value);
	if (uEl) uEl.value = vu.unit;
	if (pEl) pEl.textContent = String(Math.max(0, Math.floor(sec)));
  }
  document.addEventListener('DOMContentLoaded', () => {
	const typeSel = document.getElementById("typeSel");
	if (typeSel) typeSel.addEventListener("change", toggleSections);
	toggleSections();
	initDelayUI();
	const vEl = document.getElementById('delayValue');
	const uEl = document.getElementById('delayUnit');
	if (vEl) vEl.addEventListener('input', applyDelayToSeconds);
	if (uEl) uEl.addEventListener('change', applyDelayToSeconds);
  });
</script>

{% endblock %}

